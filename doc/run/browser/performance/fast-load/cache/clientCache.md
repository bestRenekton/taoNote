# Cache
æˆ‘ä»¬çŸ¥é“HTTPçš„ç¼“å­˜å±äºå®¢æˆ·ç«¯ç¼“å­˜ï¼Œåé¢ä¼šæåˆ°ä¸ºä»€ä¹ˆå±äºå®¢æˆ·ç«¯ç¼“å­˜ã€‚æ‰€ä»¥æˆ‘ä»¬è®¤ä¸ºæµè§ˆå™¨å­˜åœ¨ä¸€ä¸ªç¼“å­˜æ•°æ®åº“ï¼Œç”¨äºå‚¨å­˜ä¸€äº›ä¸ç»å¸¸å˜åŒ–çš„é™æ€æ–‡ä»¶ï¼ˆå›¾ç‰‡ã€cssã€jsç­‰ï¼‰ã€‚æˆ‘ä»¬å°†ç¼“å­˜åˆ†ä¸ºå¼ºåˆ¶ç¼“å­˜å’Œåå•†ç¼“å­˜ã€‚ä¸‹é¢æˆ‘å°†åˆ†åˆ«è¯¦ç»†çš„ä»‹ç»è¿™ä¸¤ç§ç¼“å­˜çš„ç¼“å­˜è§„åˆ™ã€‚

## ç¼“å­˜ç­–ç•¥
### å¼ºåˆ¶ç¼“å­˜
å½“ç¼“å­˜æ•°æ®åº“ä¸­å·²æœ‰æ‰€è¯·æ±‚çš„æ•°æ®æ—¶ã€‚å®¢æˆ·ç«¯ç›´æ¥ä»ç¼“å­˜æ•°æ®åº“ä¸­è·å–æ•°æ®ã€‚å½“ç¼“å­˜æ•°æ®åº“ä¸­æ²¡æœ‰æ‰€è¯·æ±‚çš„æ•°æ®æ—¶ï¼Œå®¢æˆ·ç«¯çš„æ‰ä¼šä»æœåŠ¡ç«¯è·å–æ•°æ®ã€‚è§¦å‘å¼ºåˆ¶ç¼“å­˜åï¼ŒFirefoxæµè§ˆå™¨è¡¨ç°ä¸ºä¸€ä¸ªç°è‰²çš„200çŠ¶æ€ç ã€‚chromeä¸º200 (from disk cache)æˆ–æ˜¯200 OK (from memory cache)ï¼Œè¿™é‡Œchromeä¼šæ ¹æ®ä½ çš„å†…å­˜æƒ…å†µæ¥é€‰æ‹©å­˜åœ¨å†…å­˜è¿˜æ˜¯ç¡¬ç›˜
+ Expires
+ Cache-Control
    + max-age=[ç§’]	ç¼“å­˜çš„æ—¶é•¿ï¼Œä¹Ÿæ˜¯å“åº”çš„æœ€å¤§çš„Ageå€¼
    + no-store	ä¸ç¼“å­˜è¯·æ±‚æˆ–æ˜¯å“åº”çš„ä»»ä½•å†…å®¹
    + no-cache	å¼ºåˆ¶æºæœåŠ¡å™¨å†æ¬¡éªŒè¯ç¼“å­˜æ˜¯å¦å¯ç”¨
    + max-age=0å’Œno-cacheåº”è¯¥æ˜¯ä»è¯­æ°”ä¸Šä¸åŒã€‚max-age=0æ˜¯å‘Šè¯‰å®¢æˆ·ç«¯èµ„æºçš„ç¼“å­˜åˆ°æœŸåº”è¯¥å‘æœåŠ¡å™¨éªŒè¯ç¼“å­˜çš„æœ‰æ•ˆæ€§ã€‚è€Œno-cacheåˆ™å‘Šè¯‰å®¢æˆ·ç«¯ä½¿ç”¨ç¼“å­˜å‰å¿…é¡»å‘æœåŠ¡å™¨éªŒè¯ç¼“å­˜çš„æœ‰æ•ˆæ€§ã€‚
    + private å®¢æˆ·ç«¯å¯ä»¥ç¼“å­˜ 
    + public å®¢æˆ·ç«¯å’Œä»£ç†æœåŠ¡å™¨éƒ½å¯ä»¥ç¼“å­˜ 
+ Cache-Controlä¼˜å…ˆçº§å¤§äºExpires

### åå•†ç¼“å­˜
åˆç§°å¯¹æ¯”ç¼“å­˜ï¼Œå®¢æˆ·ç«¯ä¼šå…ˆä»ç¼“å­˜æ•°æ®åº“ä¸­è·å–åˆ°ä¸€ä¸ªç¼“å­˜æ•°æ®çš„æ ‡è¯†ï¼Œå¾—åˆ°æ ‡è¯†åè¯·æ±‚æœåŠ¡ç«¯éªŒè¯æ˜¯å¦å¤±æ•ˆï¼ˆæ–°é²œï¼‰ï¼Œå¦‚æœæ²¡æœ‰å¤±æ•ˆæœåŠ¡ç«¯ä¼šè¿”å›304ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ç›´æ¥ä»ç¼“å­˜ä¸­è·å–æ‰€è¯·æ±‚çš„æ•°æ®ï¼Œå¦‚æœæ ‡è¯†å¤±æ•ˆï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›æ›´æ–°åçš„æ•°æ®ã€‚

ä¸¤ç±»ç¼“å­˜æœºåˆ¶å¯ä»¥åŒæ—¶å­˜åœ¨ï¼Œå¼ºåˆ¶ç¼“å­˜çš„ä¼˜å…ˆçº§é«˜äºåå•†ç¼“å­˜ï¼Œå½“æ‰§è¡Œå¼ºåˆ¶ç¼“å­˜æ—¶ï¼Œå¦‚è‹¥ç¼“å­˜å‘½ä¸­ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®åº“æ•°æ®ï¼Œä¸åœ¨è¿›è¡Œç¼“å­˜åå•†ã€‚



+ Last-Modified
    + If-Moified-Since
    + åœ¨æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚æŸä¸€ä¸ªURLæ—¶ï¼ŒæœåŠ¡å™¨ç«¯çš„è¿”å›çŠ¶æ€ç ä¼šæ˜¯200ï¼Œå“åº”çš„å®ä½“å†…å®¹æ˜¯å®¢æˆ·ç«¯è¯·æ±‚çš„èµ„æºï¼ŒåŒæ—¶æœ‰ä¸€ä¸ªLast-Modifiedçš„å±æ€§æ ‡è®°æ­¤æ–‡ä»¶åœ¨æœåŠ¡å™¨ç«¯æœ€åè¢«ä¿®æ”¹çš„æ—¶é—´ã€‚`Last-Modified : Fri , 12 May 2006 18:53:33 GMT`
    + å½“æµè§ˆå™¨ç¬¬äºŒæ¬¡è¯·æ±‚è¿™ä¸ªURLçš„æ—¶å€™ï¼Œæ ¹æ®HTTPåè®®è§„å®šï¼Œæµè§ˆå™¨ä¼šæŠŠç¬¬ä¸€æ¬¡Last-Modifiedçš„å€¼å­˜å‚¨åœ¨If-Modified-Sinceé‡Œé¢å‘é€ç»™æœåŠ¡ç«¯æ¥éªŒè¯èµ„æºæœ‰æ²¡æœ‰ä¿®æ”¹ã€‚`If-Modified-Since : Fri , 12 May 2006 18:53:33 GMT`
    + æœåŠ¡ç«¯é€šè¿‡If-Modified-Sinceå­—æ®µæ¥åˆ¤æ–­åœ¨è¿™ä¸¤æ¬¡è®¿é—®æœŸé—´èµ„æºæœ‰æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼Œä»è€Œå†³å®šæ˜¯å¦è¿”å›å®Œæ•´çš„èµ„æºã€‚å¦‚æœæœ‰ä¿®æ”¹æ­£å¸¸è¿”å›èµ„æºï¼ŒçŠ¶æ€ç 200ï¼Œå¦‚æœæ²¡æœ‰ä¿®æ”¹åªè¿”å›å“åº”å¤´ï¼ŒçŠ¶æ€ç `304`ï¼Œå‘ŠçŸ¥æµè§ˆå™¨èµ„æºçš„æœ¬åœ°ç¼“å­˜è¿˜å¯ç”¨ã€‚
    + Last-Modifiedæœ‰å‡ ä¸ªç¼ºç‚¹ï¼šæ²¡æ³•å‡†ç¡®çš„åˆ¤æ–­èµ„æºæ˜¯å¦çœŸçš„ä¿®æ”¹äº†ï¼Œæ¯”å¦‚æŸä¸ªæ–‡ä»¶åœ¨1ç§’å†…é¢‘ç¹æ›´æ”¹äº†å¤šæ¬¡ï¼Œæ ¹æ®Last-Modifiedçš„æ—¶é—´(å•ä½æ˜¯ç§’)æ˜¯åˆ¤æ–­ä¸å‡ºæ¥çš„ï¼Œå†æ¯”å¦‚ï¼ŒæŸä¸ªèµ„æºåªæ˜¯ä¿®æ”¹äº†ï¼Œä½†å®é™…å†…å®¹å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼ŒLast-Modifiedä¹Ÿæ— æ³•åˆ¤æ–­å‡ºæ¥ï¼Œå› æ­¤åœ¨HTTP/1.1ä¸­è¿˜æ¨å‡ºäº†ETagè¿™ä¸ªå­—æ®µğŸ‘‡

+ Etag
    + If-None-Match
    + åœ¨æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚æŸä¸€ä¸ªURLæ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥é€šè¿‡æŸç§è‡ªå®šçš„ç®—æ³•å¯¹èµ„æºç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†(æ¯”å¦‚md5æ ‡è¯†)ï¼Œ
    å¹¶è¿”ç»™æµè§ˆå™¨`ETag: abc-123456`
    + å½“æµè§ˆå™¨ç¬¬äºŒæ¬¡è¯·æ±‚è¿™ä¸ªURLçš„æ—¶å€™ï¼Œæ ¹æ®HTTPåè®®è§„å®šï¼Œæµè§ˆå™¨å›æŠŠç¬¬ä¸€æ¬¡ETagçš„å€¼å­˜å‚¨åœ¨If-None-Matché‡Œé¢å‘é€ç»™æœåŠ¡ç«¯æ¥éªŒè¯èµ„æºæœ‰æ²¡æœ‰ä¿®æ”¹ã€‚`If-None-Match: abc-123456`
    + Getè¯·æ±‚ä¸­ï¼Œå½“ä¸”ä»…å½“æœåŠ¡å™¨ä¸Šæ²¡æœ‰ä»»ä½•èµ„æºçš„ETagå±æ€§å€¼ä¸è¿™ä¸ªé¦–éƒ¨ä¸­åˆ—å‡ºçš„ç›¸åŒ¹é…çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ç«¯ä¼šæ‰è¿”å›æ‰€è¯·æ±‚çš„èµ„æºï¼Œå“åº”ç ä¸º200ã€‚å¦‚æœæ²¡æœ‰èµ„æºçš„ETagå€¼ç›¸åŒ¹é…ï¼Œé‚£ä¹ˆè¿”å›`304`çŠ¶æ€ç ã€‚
    + `POSTã€PUT`ç­‰è¯·æ±‚æ”¹å˜æ–‡ä»¶çš„è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰èµ„æºçš„ETagå€¼ç›¸åŒ¹é…ï¼Œé‚£ä¹ˆè¿”å›`412`çŠ¶æ€ç ã€‚
    + å½“ç„¶å’ŒLast-Modifiedç›¸æ¯”ï¼ŒETagä¹Ÿæœ‰è‡ªå·±çš„ç¼ºç‚¹ï¼Œæ¯”å¦‚ç”±äºéœ€è¦å¯¹èµ„æºè¿›è¡Œç”Ÿæˆæ ‡è¯†ï¼Œæ€§èƒ½æ–¹é¢å°±åŠ¿å¿…æœ‰æ‰€ç‰ºç‰²ã€‚
+ If-None-Matchä¼˜å…ˆçº§å¤§äºLast-Modified
### å¯å‘å¼ç¼“å­˜
```
Age:23146
Cache-Control: public
Date:Tue, 28 Nov 2017 12:26:41 GMT
Last-Modified:Tue, 28 Nov 2017 05:14:02 GMT
Vary:Accept-Encoding
```

å¦‚æœæµè§ˆå™¨ç”¨æ¥ç¡®å®šç¼“å­˜è¿‡æœŸæ—¶é—´çš„å­—æ®µä¸€ä¸ªéƒ½æ²¡æœ‰ï¼é‚£è¯¥æ€ä¹ˆåŠï¼Ÿå¯å‘å¼ç¼“å­˜ï¼
æ ¹æ®å“åº”å¤´ä¸­2ä¸ªæ—¶é—´å­—æ®µ Date å’Œ Last-Modified ä¹‹é—´çš„æ—¶é—´å·®å€¼ï¼Œå–å…¶å€¼çš„10%ä½œä¸ºç¼“å­˜æ—¶é—´å‘¨æœŸã€‚



## ç”¨æˆ·è¡Œä¸º
+ æ‰“å¼€æ–°çª—å£
å¦‚æœæŒ‡å®šcache-controlçš„å€¼ä¸ºprivateã€no-cacheã€must-revalidate,é‚£ä¹ˆæ‰“å¼€æ–°çª—å£è®¿é—®æ—¶éƒ½ä¼šé‡æ–°è®¿é—®æœåŠ¡å™¨ã€‚è€Œå¦‚æœæŒ‡å®šäº†max-ageå€¼,é‚£ä¹ˆåœ¨æ­¤å€¼å†…çš„æ—¶é—´é‡Œå°±ä¸ä¼šé‡æ–°è®¿é—®æœåŠ¡å™¨
+ åœ¨åœ°å€æ å›è½¦
å¦‚æœå€¼ä¸ºprivateæˆ–must-revalidate,åˆ™åªæœ‰ç¬¬ä¸€æ¬¡è®¿é—®æ—¶ä¼šè®¿é—®æœåŠ¡å™¨,ä»¥åå°±ä¸å†è®¿é—®ã€‚å¦‚æœå€¼ä¸ºno-cache,é‚£ä¹ˆæ¯æ¬¡éƒ½ä¼šè®¿é—®ã€‚å¦‚æœå€¼ä¸ºmax-age,åˆ™åœ¨è¿‡æœŸä¹‹å‰ä¸ä¼šé‡å¤è®¿é—®ã€‚
+ æŒ‰åé€€æŒ‰æ‰­
å¦‚æœå€¼ä¸ºprivateã€must-revalidateã€max-age,åˆ™ä¸ä¼šé‡è®¿é—®,è€Œå¦‚æœä¸ºno-cache,åˆ™æ¯æ¬¡éƒ½é‡å¤è®¿é—®.
+ æŒ‰åˆ·æ–°æŒ‰æ‰­ F5
æ— è®ºä¸ºä½•å€¼,éƒ½ä¼šé‡å¤è®¿é—®.è¯·æ±‚å¸¦ä¸ŠIf-Modify-sinceï¼Œå»æœåŠ¡å™¨çœ‹çœ‹è¿™ä¸ªæ–‡ä»¶æ˜¯å¦æœ‰è¿‡æœŸäº†
+ æŒ‰å¼ºåˆ¶åˆ·æ–°æŒ‰é’® CTRL/F5
æµè§ˆå™¨åˆ é™¤ç¼“å­˜ï¼Œå½“åšé¦–æ¬¡è¿›å…¥é‡æ–°è¯·æ±‚(è¿”å›çŠ¶æ€ç 200)

## å®è·µ
> æœ€ä½³å®è·µï¼Œå°±åº”è¯¥æ˜¯å°½å¯èƒ½å‘½ä¸­å¼ºç¼“å­˜ï¼ŒåŒæ—¶ï¼Œèƒ½åœ¨æ›´æ–°ç‰ˆæœ¬çš„æ—¶å€™è®©å®¢æˆ·ç«¯çš„ç¼“å­˜å¤±æ•ˆã€‚

### å‰ç«¯æ‰“åŒ…åŠ hash
webpackç»™æˆ‘ä»¬æä¾›äº†ä¸‰ç§å“ˆå¸Œå€¼è®¡ç®—æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯hashã€chunkhashå’Œcontenthash
+ hash
    + åªè¦æœ‰ä¸€ä¸ªæ–‡ä»¶å˜åŒ–ï¼Œæ•´ä¸ªé¡¹ç›®éƒ½hashéƒ½ä¼šå˜ï¼Œæ˜¾ç„¶ä¸è¡Œ
    ```js
        const path = require('path');
        module.exports = {
            entry: {
                index: './src/index.js',
                main: './src/main.js'
            },
            output: {
                path: path.resolve(__dirname, 'dist'),
                filename: '[name].[hash].js',
            }
        }
    ```
+ chunkhash
    + åŒä¸€æ¨¡å—ä¸­ä¸€ä¸ªæ–‡ä»¶å˜åŒ–ï¼Œæ•´ä¸ªæ¨¡å—hashå˜åŒ–ã€‚çœ‹èµ·æ¥è¿˜è¡Œï¼Œä¸è¿‡å¦‚æœjså’Œcssæ˜¯åˆ†å¼€äº†çš„ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªå˜åŒ–ï¼Œæ•´ä¸ªæ¨¡å—çš„jså’Œcsséƒ½ä¼šå˜
    ```js
        module.exports = {
            output: {
                path: path.resolve(__dirname, 'dist'),
                filename: '[name].[chunkhash].js',
            }
        }
    ```
+ contenthash
    + åªè¦æ–‡ä»¶å†…å®¹ä¸ä¸€æ ·ï¼Œæ–‡ä»¶äº§ç”Ÿçš„å“ˆå¸Œå€¼å°±ä¸ä¸€æ ·ï¼Œæ˜¾ç„¶è¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„
    ```js
        module.exports = {
            output: {
                path: path.resolve(__dirname, 'dist')
                filename: '[name].[contenthash].js',
            }
        };
    ```
### Nginx
+ å®˜æ–¹é»˜è®¤å¼€å¯ETagï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸ç”¨åšç‰¹åˆ«è®¾ç½®äº†

### åç«¯
+ å¼ºåˆ¶ç¼“å­˜
```js
res.setHeader('Cache-Control', 'public, max-age=xxx');
```
+ åå•†ç¼“å­˜
```js
res.setHeader('Cache-Control', 'public, max-age=0');
res.setHeader('Last-Modified', xxx);
res.setHeader('ETag', xxx);
```
+ å½“ç„¶ä¹Ÿæœ‰å¾ˆå¤šåº“,æ¯”å¦‚koaçš„koa-static
```js
const KoaStatic = require('koa-static');
app.use(KoaStatic('./',{ maxAge: 365 * 24 * 60 * 60 }));
```